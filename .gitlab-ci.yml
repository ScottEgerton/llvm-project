image: ubuntu:20.04

before_script:
  - export RUNNER_MAX_LINK_JOBS=`free --giga | grep Mem | awk '{print int($2 / 16)}'`

build:
  stage: build
  tags:
    - llvm

  script:
    - mkdir build
    - cd build
    - >
      cmake ../llvm
      -G Ninja
      -DLLVM_PARALLEL_LINK_JOBS=${RUNNER_MAX_LINK_JOBS}
      -DLLVM_TARGETS_TO_BUILD="X86;RISCV"
      -DBUILD_SHARED_LIBS=ON
      -DLLVM_OPTIMIZED_TABLEGEN=ON
      -DLLVM_USE_SPLIT_DWARF=ON
    - ninja check-llvm-mc-riscv
